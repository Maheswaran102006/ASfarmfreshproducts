<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AS Fresh Farm Products â€” Order Online</title>
<style>
:root{--green:#2d6a3a;--accent:#f7d46c;--muted:#666}
*{box-sizing:border-box}
body{font-family:Arial,Helvetica,sans-serif;margin:0;background:#faf9f6;color:#222}
header{background:linear-gradient(180deg,var(--accent),#fff7cc);border-bottom:2px solid #e0c25f;padding:12px 16px;display:flex;align-items:center;justify-content:center;position:sticky;top:0;z-index:1400}
header img{height:56px;border-radius:8px;margin-right:12px}
.header-title{font-family:'Times New Roman',serif;margin:0;color:var(--green);font-size:22px}
.hamburger{position:absolute;left:12px}
.hamburger button{background:none;border:none;font-size:24px;cursor:pointer}
.container{max-width:1100px;margin:18px auto;padding:0 16px;display:grid;grid-template-columns:1fr 360px;gap:18px}
@media(max-width:960px){.container{grid-template-columns:1fr}}
.hero{background:url('assets/background.jpg')center/cover;border-radius:10px;padding:20px;color:#fff;display:flex;gap:16px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:18px;margin-top:18px}
.card{background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 6px 18px rgba(0,0,0,0.08);display:flex;flex-direction:column}
.card img{width:100%;height:160px;object-fit:cover}
.card .content{padding:12px;flex:1;display:flex;flex-direction:column;justify-content:space-between}
.card h3{margin:0 0 6px;font-size:16px}
.price{font-weight:bold;color:var(--green)}
.product-controls{display:flex;align-items:center;gap:8px;margin-top:10px}
.qty-btn{width:34px;height:34px;border-radius:6px;border:1px solid #ccc;background:#fff;cursor:pointer}
.add-btn{background:var(--green);color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer}
.small{font-size:13px;color:var(--muted)}

/* Flipkart-like order drawer / summary */
.order-summary{background:#fff;border-radius:8px;padding:12px;box-shadow:0 8px 30px rgba(0,0,0,0.08);position:sticky;top:88px;height:fit-content}
.order-summary h3{margin:0 0 8px}
.order-items{max-height:420px;overflow:auto;margin-bottom:8px}
.order-row{display:flex;gap:8px;align-items:center;padding:8px;border-radius:6px;border:1px solid #f0efe6;margin-bottom:8px}
.order-row img{width:64px;height:64px;object-fit:cover;border-radius:6px}
.order-row .meta{flex:1}
.row-controls{display:flex;align-items:center;gap:6px}
.summary-line{display:flex;justify-content:space-between;padding:6px 0;border-top:1px dashed #eee}
.total-line{display:flex;justify-content:space-between;padding:10px 0;font-weight:bold}
.checkout-btn{width:100%;background:var(--green);color:#fff;border:none;padding:10px;border-radius:6px;cursor:pointer;font-size:16px}
.clear-btn{width:100%;background:#f1f1f1;color:#333;border:none;padding:8px;border-radius:6px;cursor:pointer}

/* drawer for mobile */
.drawer{position:fixed;right:0;top:0;bottom:0;width:100%;max-width:420px;background:#fff;box-shadow:-12px 0 40px rgba(0,0,0,0.2);transform:translateX(110%);transition:transform .28s ease;z-index:1600;padding:14px;display:flex;flex-direction:column}
.drawer.open{transform:translateX(0)}
.close-drawer{align-self:flex-end;background:none;border:none;font-size:26px;cursor:pointer}

/* nav menu (hamburger) */
.nav-menu{display:none;position:fixed;top:64px;left:12px;background:#fff;padding:8px;border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,0.12);z-index:1600}
.nav-menu a{display:block;padding:8px 12px;color:#2d6a3a;text-decoration:none;font-weight:bold}

/* small screens */
@media(max-width:960px){
  .order-summary{display:none}
  .container{padding-bottom:90px}
}

/* invoice print style */
.invoice{font-family:'Times New Roman',serif;background:linear-gradient(90deg,#fff6d6,#ffffff);padding:12px;border-radius:8px}
</style>
</head>
<body>

<header>
  <div class="hamburger"><button id="hambBtn" aria-label="Open menu">â˜°</button></div>
  <img src="assets/logo.jpeg" alt="AS Farm Fresh Logo"/>
  <h1 class="header-title">AS Fresh Farm Products</h1>
</header>

<!-- Nav menu used by the hamburger -->
<nav id="navMenu" class="nav-menu" aria-label="Main menu">
  <a href="#home" data-target="home">Home</a>
  <a href="#about" data-target="about">About</a>
  <a href="#posts" data-target="posts">Posts</a>
  <a href="#contact" data-target="contact">Contact</a>
  <a href="#" id="openOrderBtn">Order / Pre-book</a>
</nav>

<main class="container" id="home">
  <section>
    <div class="hero">
      <div style="flex:1">
        <h2 style="margin:0 0 6px">Pure Buffalo Milk â€¢ Paneer â€¢ Ghee</h2>
        <p style="margin:0 0 6px">Farm-fresh, preservative-free dairy products directly from our farm.</p>
        <p style="margin:0"><strong>Contact:</strong> asfarmfresh01@gmail.com â€¢ +91 8056748395</p>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <img src="assets/milk.png" alt="milk" style="height:80px;background:#fff;padding:8px;border-radius:8px">
      </div>
    </div>

    <section style="margin-top:18px">
      <h3>Products</h3>
      <div class="grid" id="productsGrid"></div>
    </section>

    <section id="posts" style="margin-top:26px">
      <h3>Posts (Admin)</h3>
      <div style="display:flex;gap:8px;margin-bottom:8px">
        <button onclick="openAdmin()">Admin Upload</button>
        <button onclick="loadPosts()">Refresh Posts</button>
      </div>
      <div id="postsGrid"></div>
    </section>

    <section id="about" style="margin-top:26px">
      <h3>About</h3>
      <p>Located at North Street, Kasanadupudur, Thanjavur â€” sustainable & ethical dairy farming.</p>
    </section>

    <section id="contact" style="margin-top:26px">
      <h3>Contact</h3>
      <p>Email: asfarmfresh01@gmail.com</p>
      <p>Phone: +91 8056748395</p>
    </section>
  </section>

  <!-- desktop summary -->
  <aside class="order-summary" id="orderSummary">
    <h3>Order Summary</h3>
    <div id="orderItems" class="order-items"><div class="small">No items yet â€” add products to start.</div></div>

    <div class="summary-line"><div>Subtotal</div><div id="subtotal">â‚¹0.00</div></div>
    <div class="summary-line"><div>GST (5%)</div><div id="gst">â‚¹0.00</div></div>
    <div class="summary-line"><div>Delivery</div><div id="delivery">â‚¹0.00</div></div>
    <div class="total-line"><div>Total</div><div id="total">â‚¹0.00</div></div>

    <div style="margin-top:8px">
      <button class="checkout-btn" onclick="openCheckout()">Place Order</button>
      <button class="clear-btn" onclick="clearCart()" style="margin-top:8px">Clear</button>
    </div>
    <div style="margin-top:8px;font-size:13px;color:var(--muted)">Orders are emailed automatically to <strong>asfarmfresh01@gmail.com</strong> when you complete checkout (configure EmailJS or Formspree below).</div>
  </aside>
</main>

<!-- Checkout drawer / modal (mobile & desktop) -->
<div id="checkoutDrawer" class="drawer" aria-hidden="true">
  <button class="close-drawer" onclick="closeCheckout()">Ã—</button>
  <h3>Checkout â€” AS Fresh Farm Products</h3>

  <div id="drawerItems" style="margin:8px 0;max-height:220px;overflow:auto"></div>

  <div style="margin-top:8px">
    <label>Customer name:<br><input type="text" id="custName" placeholder="Name" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px"></label>
  </div>
  <div style="margin-top:8px">
    <label>Mobile number:<br><input type="text" id="custMobile" placeholder="+91 9xxxxxxxxx" value="+91 8056748395" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px"></label>
  </div>

  <div style="margin-top:8px">
    <label>Delivery address:<br><textarea id="custAddress" rows="3" placeholder="Flat / House, Street, Landmark, City, PIN" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px"></textarea></label>
  </div>

  <div style="margin-top:8px;display:flex;gap:8px">
    <label style="flex:1">Payment method:<br>
      <select id="paymentMethod" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px">
        <option value="cod">Cash on delivery</option>
        <option value="upi">UPI / Transfer</option>
      </select>
    </label>
    <label style="flex:1">Order type:<br>
      <select id="orderType" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px">
        <option value="order">Order Now</option>
        <option value="prebook">Pre-book</option>
      </select>
    </label>
  </div>

  <div style="margin-top:8px" id="checkoutSummary">
    <div class="summary-line"><div>Subtotal</div><div id="subtotal2">â‚¹0.00</div></div>
    <div class="summary-line"><div>GST (5%)</div><div id="gst2">â‚¹0.00</div></div>
    <div class="total-line"><div>Total</div><div id="total2">â‚¹0.00</div></div>
  </div>

  <div style="margin-top:10px;display:flex;gap:8px">
    <button class="checkout-btn" onclick="confirmAndSend()">Confirm & Pay / Send</button>
    <button class="clear-btn" onclick="closeCheckout()">Cancel</button>
  </div>

  <div id="invoiceWrap" style="display:none;margin-top:12px">
    <div class="invoice" id="invoiceContent"></div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button onclick="printInvoice()">Download / Print Bill</button>
      <button class="clear-btn" onclick="resendInvoice()">Resend Email</button>
    </div>
  </div>

  <div style="height:28px"></div>
</div>

<!-- Admin modal (unchanged logic) -->
<div id="adminModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);align-items:center;justify-content:center;z-index:1700">
  <div style="background:#fff;padding:16px;border-radius:8px;max-width:720px;width:100%;position:relative">
    <button onclick="closeAdmin()" style="position:absolute;right:10px;top:8px;background:none;border:none;font-size:22px">Ã—</button>
    <h3>Admin Upload (password required)</h3>
    <div style="display:flex;gap:8px;margin-bottom:8px">
      <input type="password" id="adminPass" placeholder="Enter password">
      <button onclick="adminLogin()">Unlock</button>
      <button onclick="closeAdmin()">Close</button>
    </div>
    <div id="adminArea" style="display:none">
      <p>Upload image / video / pdf to create a post.</p>
      <input type="file" id="postFile" accept="image/*,video/*,application/pdf" />
      <input type="text" id="postTitle" placeholder="Post title / caption" style="width:100%;margin-top:8px"/>
      <div style="margin-top:8px;display:flex;gap:8px">
        <button onclick="createPost()">Upload Post</button>
        <button onclick="lockAdmin()">Lock</button>
      </div>
    </div>
  </div>
</div>

<footer style="text-align:center;padding:14px;color:#555">Â© AS Fresh Farm Products â€” All rights reserved</footer>

<script>
/* ===========================
  CONFIG - EDIT THESE
   - To send email automatically you must configure either:
     A) EmailJS: set EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, EMAILJS_PUBLIC_KEY
     B) OR FORM_ENDPOINT (webhook/Formspree)
   - If both set, EmailJS is used first. If neither set, email will open mail client (mailto) as fallback.
   ============================ */

const FARM_EMAIL = 'asfarmfresh01@gmail.com';
const FARM_MOBILE = '+918056748395';
const ADMIN_PASSWORD = 'asfarm8056';

// Replace these with your EmailJS credentials to enable automatic email sending via EmailJS.
const EMAILJS_SERVICE_ID = 'YOUR_EMAILJS_SERVICE_ID';      // e.g. 'service_xxx'
const EMAILJS_TEMPLATE_ID = 'YOUR_EMAILJS_TEMPLATE_ID';   // e.g. 'template_xxx'
const EMAILJS_PUBLIC_KEY = 'YOUR_EMAILJS_PUBLIC_KEY';     // e.g. 'user_xxx'

// OR set FORM_ENDPOINT to a webhook (Formspree/Make/Node endpoint)
const FORM_ENDPOINT = ''; // e.g. 'https://formspree.io/f/xxxxxx' or your webhook URL

/* ===========================
   PRODUCTS (prices)
   ============================ */
const PRODUCTS = [
  { id:'milk', title:'Buffalo Milk', pricePerL:60, img:'assets/milk.png', unit:'L' },
  { id:'paneer', title:'Paneer', pricePerKg:150, img:'assets/paneer.png', unit:'kg' },
  { id:'ghee', title:'Ghee', pricePerL:400, img:'assets/ghee.png', unit:'L' }
];

let cart = {}; // {id:{qty,unit,rate,title}}
const GST_RATE = 0.05;
const DELIVERY_CHARGE = 0; // set if you charge delivery

/* ===========================
   Load EmailJS lib if keys set
   ============================ */
(function loadEmailJSIfConfigured(){
  if (EMAILJS_PUBLIC_KEY && EMAILJS_PUBLIC_KEY !== 'YOUR_EMAILJS_PUBLIC_KEY') {
    const s = document.createElement('script');
    s.src = "https://cdn.jsdelivr.net/npm/emailjs-com@2.6.4/dist/email.min.js";
    s.onload = () => {
      try { if (window.emailjs) { emailjs.init(EMAILJS_PUBLIC_KEY); console.log('EmailJS initialized'); } }
      catch(e){ console.warn('EmailJS init failed', e); }
    };
    s.onerror = (e) => { console.warn('Failed to load EmailJS script', e); };
    document.head.appendChild(s);
  } else {
    console.log('EmailJS not configured (placeholders present).');
  }
})();

/* ===========================
   Initialize UI
   ============================ */
document.addEventListener('DOMContentLoaded', () => {
  renderProducts();
  restoreCart();
  updateSummaryUI();

  // wire openOrderBtn in nav menu
  const openOrderBtn = document.getElementById('openOrderBtn');
  if (openOrderBtn) openOrderBtn.addEventListener('click', (e)=>{ e.preventDefault(); openCheckout(); document.getElementById('navMenu').style.display='none'; });

  // Robust hamburger/menu wiring
  (function wireHamburger(){
    const hamb = document.getElementById('hambBtn');
    const menu = document.getElementById('navMenu');

    if (!hamb) console.warn('Hamburger button (#hambBtn) not found');
    if (!menu) console.warn('Nav menu (#navMenu) not found');

    function openMenu(){ if (!menu) return; menu.style.display = 'block'; hamb.setAttribute('aria-expanded','true'); }
    function closeMenu(){ if (!menu) return; menu.style.display = 'none'; hamb.setAttribute('aria-expanded','false'); }
    function toggleMenu(){ if (!menu) return; menu.style.display = menu.style.display === 'block' ? 'none' : 'block'; hamb.setAttribute('aria-expanded', (menu.style.display==='block').toString()); }

    if (hamb) {
      hamb.addEventListener('click', function(e){
        e.stopPropagation();
        toggleMenu();
      });
    }

    // Close when clicking outside
    document.addEventListener('click', function(e){
      if (!menu) return;
      if (menu.style.display !== 'block') return;
      if (menu.contains(e.target) || (hamb && hamb.contains(e.target))) return;
      closeMenu();
    }, { capture:true });

    // Close on Escape
    document.addEventListener('keydown', function(e){
      if (e.key === 'Escape') closeMenu();
    });

    // Wire nav links (smooth scroll and close)
    if (menu) {
      menu.querySelectorAll('a[data-target]').forEach(a => {
        a.addEventListener('click', function(ev){
          ev.preventDefault();
          closeMenu();
          const id = a.getAttribute('data-target');
          const el = document.getElementById(id);
          if (el) el.scrollIntoView({behavior:'smooth'});
        });
      });
    }

    console.log('Hamburger/menu wiring initialized');
  })();
});

/* ===========================
   Render products grid (with qty inputs)
   ============================ */
function renderProducts(){
  const grid = document.getElementById('productsGrid');
  grid.innerHTML = '';
  PRODUCTS.forEach(p => {
    const div = document.createElement('div'); div.className='card';
    div.innerHTML = `
      <img src="${p.img}" alt="${p.title}">
      <div class="content">
        <div>
          <h3>${p.title}</h3>
          <div class="small">â‚¹${(p.pricePerL||p.pricePerKg||p.pricePerKg).toFixed(0)} / ${p.unit}</div>
          <div class="product-controls" style="margin-top:8px">
            <button class="qty-btn" onclick="decrease('${p.id}')">âˆ’</button>
            <input id="qty-${p.id}" type="number" min="0" step="any" value="${getQtyFromCart(p.id)||0}" style="width:70px;padding:6px;border:1px solid #ddd;border-radius:6px">
            <button class="qty-btn" onclick="increase('${p.id}')">+</button>
            <button class="add-btn" style="margin-left:auto" onclick="addFromInput('${p.id}')">Add</button>
          </div>
        </div>
        <div class="small" style="margin-top:8px">Fresh daily from our farm.</div>
      </div>
    `;
    grid.appendChild(div);

    // wire input change
    const inp = div.querySelector(`#qty-${p.id}`);
    inp.addEventListener('change', () => {
      const val = parseFloat(inp.value)||0;
      updateCartQty(p.id, val);
    });
  });
}

/* ===========================
   Cart helpers
   ============================ */
function getQtyFromCart(id){ return cart[id] ? cart[id].qty : 0; }
function increase(id){ const cur = getQtyFromCart(id)||0; updateCartQty(id, +(cur + 0.25).toFixed(2)); }
function decrease(id){ const cur = getQtyFromCart(id)||0; updateCartQty(id, Math.max(0, +(cur - 0.25).toFixed(2))); }
function addFromInput(id){ const v = parseFloat(document.getElementById('qty-'+id).value)||0; if (!v){ alert('Enter quantity > 0'); return; } updateCartQty(id,v); alert('Added/updated'); }
function updateCartQty(id, qty){
  if (qty <= 0) { delete cart[id]; } else {
    const p = PRODUCTS.find(x=>x.id===id);
    const rate = p.pricePerL || p.pricePerKg || 0;
    cart[id] = { qty, unit: p.unit, rate, title: p.title };
  }
  saveCart();
  updateSummaryUI();
}
function removeFromCart(id){ delete cart[id]; saveCart(); updateSummaryUI(); }
function clearCart(){ cart = {}; saveCart(); updateSummaryUI(); }

/* localStorage */
function saveCart(){ localStorage.setItem('cart', JSON.stringify(cart)); }
function restoreCart(){ cart = JSON.parse(localStorage.getItem('cart')||'{}'); }

/* ===========================
   Summary / UI update
   ============================ */
function computeTotals(){
  let subtotal = 0;
  Object.keys(cart).forEach(id => {
    const it = cart[id];
    subtotal += (it.rate||0) * (it.qty||0);
  });
  const gst = +(subtotal * GST_RATE).toFixed(2);
  const total = +(subtotal + gst + DELIVERY_CHARGE).toFixed(2);
  return {subtotal:+subtotal.toFixed(2), gst, delivery:DELIVERY_CHARGE, total};
}

function updateSummaryUI(){
  const {subtotal,gst,delivery,total} = computeTotals();
  // desktop elements
  document.getElementById('orderItems').innerHTML = '';
  if (Object.keys(cart).length === 0){
    document.getElementById('orderItems').innerHTML = '<div class="small">No items yet â€” add products to start.</div>';
  } else {
    Object.keys(cart).forEach(id => {
      const it = cart[id];
      const row = document.createElement('div'); row.className='order-row';
      const p = PRODUCTS.find(x=>x.id===id);
      row.innerHTML = `
        <img src="${p.img}" alt="${p.title}">
        <div class="meta">
          <strong>${it.title}</strong>
          <div class="small">Qty: ${it.qty} ${it.unit}</div>
        </div>
        <div style="text-align:right">
          <div style="font-weight:bold">â‚¹${(it.rate*it.qty).toFixed(2)}</div>
          <div class="row-controls" style="margin-top:6px">
            <button class="qty-btn" onclick="decrease('${id}')">âˆ’</button>
            <button class="qty-btn" onclick="increase('${id}')">+</button>
            <button class="clear-btn" onclick="removeFromCart('${id}')">Del</button>
          </div>
        </div>
      `;
      document.getElementById('orderItems').appendChild(row);
    });
  }
  // numbers
  document.getElementById('subtotal').innerText = `â‚¹${subtotal.toFixed(2)}`;
  document.getElementById('gst').innerText = `â‚¹${gst.toFixed(2)}`;
  document.getElementById('delivery').innerText = `â‚¹${delivery.toFixed(2)}`;
  document.getElementById('total').innerText = `â‚¹${total.toFixed(2)}`;

  // drawer copy
  document.getElementById('drawerItems').innerHTML = buildDrawerItemsHTML();
  document.getElementById('subtotal2').innerText = `â‚¹${subtotal.toFixed(2)}`;
  document.getElementById('gst2').innerText = `â‚¹${gst.toFixed(2)}`;
  document.getElementById('total2').innerText = `â‚¹${total.toFixed(2)}`;
}

/* build HTML for drawer items */
function buildDrawerItemsHTML(){
  if (Object.keys(cart).length === 0) return '<div class="small">No items in cart</div>';
  let html = '';
  Object.keys(cart).forEach(id => {
    const it = cart[id];
    html += `<div style="display:flex;align-items:center;gap:10px;padding:8px;border-bottom:1px dashed #eee">
      <div style="flex:1"><strong>${it.title}</strong><div class="small">Qty: ${it.qty} ${it.unit}</div></div>
      <div style="text-align:right">â‚¹${(it.rate*it.qty).toFixed(2)}</div>
    </div>`;
  });
  return html;
}

/* ===========================
   Checkout drawer controls
   ============================ */
function openCheckout(){ document.getElementById('checkoutDrawer').classList.add('open'); document.getElementById('checkoutDrawer').setAttribute('aria-hidden','false'); }
function closeCheckout(){ document.getElementById('checkoutDrawer').classList.remove('open'); document.getElementById('checkoutDrawer').setAttribute('aria-hidden','true'); }

/* ===========================
   Unified sendOrderEmail (EmailJS -> FORM_ENDPOINT -> mailto fallback)
   ============================ */
async function sendOrderEmail(order){
  const mailSubject = `New order â€” AS Fresh Farm Products â€” ${new Date(order.date_iso).toLocaleString()}`;
  const itemsText = (order.items || []).map(i => `${i.title} x ${i.qty} ${i.unit} = â‚¹${i.amount.toFixed(2)}`).join('\n');
  const mailBody = `AS Fresh Farm Products - New order

Customer: ${order.customer_name}
Mobile: ${order.customer_mobile}
Address: ${order.customer_address}

Items:
${itemsText}

Subtotal: â‚¹${order.subtotal.toFixed(2)}
GST: â‚¹${order.gst.toFixed(2)}
Delivery: â‚¹${order.delivery.toFixed(2)}
Total: â‚¹${order.total.toFixed(2)}

Order date: ${new Date(order.date_iso).toLocaleString()}

Payment method: ${order.payment_method}
Order type: ${order.order_type}
`;

  // 1) Try EmailJS
  try {
    if (window.emailjs && EMAILJS_SERVICE_ID && EMAILJS_TEMPLATE_ID && EMAILJS_PUBLIC_KEY && EMAILJS_PUBLIC_KEY !== 'YOUR_EMAILJS_PUBLIC_KEY') {
      console.log('Attempting to send via EmailJS...');
      const templateParams = {
        farm_email: order.farm_email,
        farm_mobile: order.farm_mobile,
        customer_name: order.customer_name,
        customer_mobile: order.customer_mobile,
        customer_address: order.customer_address,
        payment_method: order.payment_method,
        order_type: order.order_type,
        order_items: itemsText,
        subtotal: order.subtotal.toFixed(2),
        gst: order.gst.toFixed(2),
        delivery: order.delivery.toFixed(2),
        total: order.total.toFixed(2),
        order_date: new Date(order.date_iso).toLocaleString()
      };
      await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams);
      console.log('EmailJS send succeeded');
      return { method: 'emailjs' };
    }
  } catch (e) {
    console.warn('EmailJS send failed:', e);
  }

  // 2) Try FORM_ENDPOINT webhook
  try {
    if (FORM_ENDPOINT && FORM_ENDPOINT.trim()) {
      console.log('Attempting to send via FORM_ENDPOINT...');
      const res = await fetch(FORM_ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          farm_email: order.farm_email,
          farm_mobile: order.farm_mobile,
          customer_name: order.customer_name,
          customer_mobile: order.customer_mobile,
          customer_address: order.customer_address,
          payment_method: order.payment_method,
          order_type: order.order_type,
          items: order.items,
          subtotal: order.subtotal,
          gst: order.gst,
          delivery: order.delivery,
          total: order.total,
          order_date: new Date(order.date_iso).toLocaleString()
        })
      });
      if (!res.ok) {
        const txt = await res.text().catch(()=>'(no body)');
        throw new Error('Form endpoint returned ' + res.status + ': ' + txt);
      }
      console.log('Form endpoint send succeeded');
      return { method: 'form' };
    }
  } catch (e) {
    console.warn('FORM_ENDPOINT send failed:', e);
  }

  // 3) Fallback: open default mail client (mailto)
  try {
    const mailtoLink = `mailto:${encodeURIComponent(order.farm_email)}?subject=${encodeURIComponent(mailSubject)}&body=${encodeURIComponent(mailBody)}`;
    window.open(mailtoLink, '_blank');
    console.log('Fell back to mailto: link (opened compose window).');
    return { method: 'mailto' };
  } catch (e) {
    console.error('Fallback mailto failed', e);
    throw new Error('All email methods failed');
  }
}

/* ===========================
   Confirm order: build order object, send email, open WhatsApp
   ============================ */
async function confirmAndSend(){
  const name = document.getElementById('custName').value.trim();
  const mobile = document.getElementById('custMobile').value.trim();
  const address = document.getElementById('custAddress').value.trim();
  const payment = document.getElementById('paymentMethod').value;
  const orderType = document.getElementById('orderType').value;

  if (!name || !mobile || !address){ alert('Please enter name, mobile and delivery address'); return; }
  if (Object.keys(cart).length === 0){ alert('Cart is empty'); return; }

  const totals = computeTotals();
  const items = Object.keys(cart).map(id=>{
    const it = cart[id]; return { id, title: it.title, qty: it.qty, unit: it.unit, rate: it.rate, amount: +(it.rate*it.qty).toFixed(2) };
  });

  const order = {
    farm_email: FARM_EMAIL,
    farm_mobile: FARM_MOBILE,
    customer_name: name,
    customer_mobile: mobile,
    customer_address: address,
    payment_method: payment,
    order_type: orderType,
    items,
    subtotal: totals.subtotal,
    gst: totals.gst,
    delivery: totals.delivery,
    total: totals.total,
    date_iso: new Date().toISOString()
  };

  // show invoice preview
  document.getElementById('invoiceWrap').style.display = 'block';
  document.getElementById('invoiceContent').innerHTML = buildInvoiceHTML(order);

  // save to orders history
  const history = JSON.parse(localStorage.getItem('orders') || '[]');
  history.push(order);
  localStorage.setItem('orders', JSON.stringify(history));

  // send email (EmailJS -> FORM_ENDPOINT -> mailto fallback)
  try {
    await sendOrderEmail(order);
    alert('Order processed â€” check your email (or mail client) for details.');
    sendToWhatsApp(order);
    closeCheckout();
    clearCart();
    updateSummaryUI();
  } catch (err) {
    console.error('Send failed:', err);
    alert('Order generated but automatic email failed. Invoice is shown; you can print or resend later.');
  }
}

/* ===========================
   EmailJS-specific helpers (kept for resend compatibility)
   ============================ */
async function sendViaEmailJS(order){
  // convenience wrapper (not used directly if unified sender used)
  return sendOrderEmail(order);
}
async function sendViaFormEndpoint(order){
  return sendOrderEmail(order);
}

/* ===========================
   WhatsApp integration (opens chat)
   ============================ */
function normalizePhone(number){
  if (!number) return '';
  const digits = String(number).replace(/\D/g,'');
  return digits;
}
function sendToWhatsApp(order){
  try {
    const itemsText = order.items.map(i=>`${i.title} (${i.qty} ${i.unit}) - â‚¹${i.amount.toFixed(2)}`).join('\n');
    const msg = `ðŸ§¾ AS FARM FRESH ORDER
Customer: ${order.customer_name}
Mobile: ${order.customer_mobile}
Address: ${order.customer_address}
Items:
${itemsText}
Subtotal: â‚¹${order.subtotal.toFixed(2)}
GST: â‚¹${order.gst.toFixed(2)}
Total: â‚¹${order.total.toFixed(2)}
Date: ${new Date(order.date_iso).toLocaleString()}`;
    // farm
    const farmNum = normalizePhone(order.farm_mobile);
    if (farmNum) window.open(`https://wa.me/${farmNum}?text=${encodeURIComponent(msg)}`, '_blank');
    // customer (if number present)
    let cust = normalizePhone(order.customer_mobile);
    if (cust.length === 10) cust = '91'+cust;
    if (cust) window.open(`https://wa.me/${cust}?text=${encodeURIComponent('Your order has been placed. We will contact you shortly.\n\n'+ msg)}`, '_blank');
  } catch(e){ console.error('WA failed', e); }
}

/* ===========================
   Invoice HTML + print
   ============================ */
function buildInvoiceHTML(order){
  const rows = order.items.map(it => `<tr><td style="padding:6px">${escapeHTML(it.title)}</td><td style="padding:6px">${it.qty} ${it.unit}</td><td style="padding:6px">â‚¹${it.rate.toFixed(2)}</td><td style="padding:6px">â‚¹${it.amount.toFixed(2)}</td></tr>`).join('');
  return `
    <div>
      <h3 style="margin:0">AS Fresh Farm Products â€” Invoice</h3>
      <p style="margin:6px 0">Customer: ${escapeHTML(order.customer_name)}<br/>Mobile: ${escapeHTML(order.customer_mobile)}<br/>Address: ${escapeHTML(order.customer_address)}<br/>Date: ${new Date(order.date_iso).toLocaleString()}</p>
      <table style="width:100%;border-collapse:collapse">
        <tr><th style="text-align:left;padding:6px">Product</th><th style="padding:6px">Qty</th><th style="padding:6px">Rate</th><th style="padding:6px">Amount</th></tr>
        ${rows}
        <tr><td colspan="3" style="text-align:right;padding:6px">GST (5%)</td><td style="padding:6px">â‚¹${order.gst.toFixed(2)}</td></tr>
        <tr><td colspan="3" style="text-align:right;padding:6px"><strong>Total</strong></td><td style="padding:6px"><strong>â‚¹${order.total.toFixed(2)}</strong></td></tr>
      </table>
      <p style="margin-top:8px">Payment method: ${escapeHTML(order.payment_method)} â€” Order type: ${escapeHTML(order.order_type)}</p>
      <p style="margin:0;font-size:12px">Thank you for ordering from AS Fresh Farm Products.</p>
    </div>
  `;
}

function printInvoice(){
  const content = document.getElementById('invoiceContent').innerHTML;
  const w = window.open('','_blank','width=700,height=900');
  w.document.write('<html><head><title>Invoice</title>');
  w.document.write('<style>body{font-family:Times New Roman,serif;padding:18px;background:linear-gradient(90deg,#fff6d6,#ffffff)}</style>');
  w.document.write('</head><body>');
  w.document.write(content);
  w.document.write('</body></html>');
  w.document.close();
  w.print();
}

/* Resend last invoice */
function resendInvoice(){
  const history = JSON.parse(localStorage.getItem('orders') || '[]');
  if (!history.length){ alert('No invoice to resend'); return; }
  const last = history[history.length-1];
  const order = last;
  (async()=>{
    try {
      await sendOrderEmail(order);
      alert('Resent successfully (method logged in console).');
    } catch(e){
      console.error(e);
      alert('Resend failed. Check console for details.');
    }
  })();
}

/* ===========================
   Posts & Admin
   ============================ */
function openAdmin(){ document.getElementById('adminModal').style.display='flex'; }
function closeAdmin(){ document.getElementById('adminModal').style.display='none'; }
function lockAdmin(){ document.getElementById('adminArea').style.display='none'; document.getElementById('adminPass').value=''; }
function adminLogin(){
  const p = document.getElementById('adminPass').value || '';
  if (p === ADMIN_PASSWORD) { document.getElementById('adminArea').style.display='block'; alert('Admin unlocked â€” you may upload posts.'); }
  else alert('Incorrect password');
}
function createPost(){
  const fileInput = document.getElementById('postFile');
  const title = document.getElementById('postTitle').value || '';
  if (!fileInput.files.length){ alert('Choose a file'); return; }
  const file = fileInput.files[0];
  const reader = new FileReader();
  reader.onload = function(evt){
    const data = evt.target.result;
    const posts = JSON.parse(localStorage.getItem('posts') || '[]');
    posts.unshift({ title, type: file.type, data, date: new Date().toISOString() });
    localStorage.setItem('posts', JSON.stringify(posts));
    alert('Post uploaded');
    loadPosts();
  };
  reader.readAsDataURL(file);
}
function loadPosts(){
  const posts = JSON.parse(localStorage.getItem('posts') || '[]');
  const grid = document.getElementById('postsGrid'); grid.innerHTML = '';
  if (!posts.length){ grid.innerHTML = '<div style="padding:12px;background:#fff;border-radius:8px">No posts yet.</div>'; return; }
  posts.forEach(p=>{
    const d = document.createElement('div'); d.className='card post'; d.style.padding='8px';
    d.innerHTML = `<strong>${escapeHTML(p.title||'Untitled')}</strong><br/><small>${new Date(p.date).toLocaleString()}</small>`;
    if (p.type.startsWith('image/')) { const img=document.createElement('img'); img.src=p.data; img.style.width='100%'; img.style.borderRadius='6px'; d.appendChild(img); }
    else if (p.type.startsWith('video/')) { const v=document.createElement('video'); v.src=p.data; v.controls=true; v.style.width='100%'; d.appendChild(v); }
    else if (p.type==='application/pdf') { const a=document.createElement('a'); a.href=p.data; a.target='_blank'; a.textContent='View PDF'; d.appendChild(a); }
    grid.appendChild(d);
  });
}

/* ===========================
   Utility
   ============================ */
function escapeHTML(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
restoreCart(); updateSummaryUI();
</script>
</body>
</html>
